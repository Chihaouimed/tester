<!-- File: views/dashboard_templates.xml -->
<odoo>
    <template id="pv_dashboard_template">
        <t t-call="website.layout">
            <div class="container mt32">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="text-center mb32">Tableau de Bord de Gestion PV</h1>
                    </div>
                </div>

                <!-- KPI Boxes -->
                <div class="row mb32">
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h2><t t-esc="dashboard.total_installations"/></h2>
                                <p>Installations Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h2><t t-esc="dashboard.active_installations"/></h2>
                                <p>Installations Actives</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h2><t t-esc="dashboard.total_reclamations"/></h2>
                                <p>Réclamations</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h2><t t-esc="dashboard.pending_interventions"/></h2>
                                <p>Interventions en cours</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row mb32">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4>États des Installations</h4>
                            </div>
                            <div class="card-body">
                                <canvas id="installationChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4>Réclamations Mensuelles</h4>
                            </div>
                            <div class="card-body">
                                <canvas id="reclamationChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb32">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4>États des Interventions</h4>
                            </div>
                            <div class="card-body">
                                <canvas id="interventionChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4>Alarmes par Type</h4>
                            </div>
                            <div class="card-body">
                                <canvas id="alarmChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart.js Library -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>

            <script type="text/javascript">
                $(document).ready(function() {
                    // Load charts via AJAX
                    function loadChart(chartType, chartId) {
                        $.ajax({
                            url: '/pv_management/chart_data/' + chartType,
                            type: 'POST',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify({jsonrpc: "2.0", method: "call", params: {}}),
                            success: function(result) {
                                var chartData = JSON.parse(result.result.data);

                                if (result.result.type === 'pie') {
                                    createPieChart(chartId, chartData);
                                } else if (result.result.type === 'bar') {
                                    createBarChart(chartId, chartData);
                                }
                            },
                            error: function(error) {
                                console.log('Error loading chart data:', error);
                            }
                        });
                    }

                    // Create pie chart
                    function createPieChart(chartId, data) {
                        var ctx = document.getElementById(chartId).getContext('2d');
                        var labels = data.map(function(item) { return item.label; });
                        var values = data.map(function(item) { return item.value; });
                        var colors = data.map(function(item) { return item.color || getRandomColor(); });

                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: values,
                                    backgroundColor: colors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                legend: {
                                    position: 'bottom',
                                }
                            }
                        });
                    }

                    // Create bar chart
                    function createBarChart(chartId, data) {
                        var ctx = document.getElementById(chartId).getContext('2d');
                        var labels = data.map(function(item) { return item.name; });
                        var values = data.map(function(item) { return item.count; });

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Nombre de réclamations',
                                    data: values,
                                    backgroundColor: '#17a2b8',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    yAxes: [{
                                        ticks: {
                                            beginAtZero: true
                                        }
                                    }]
                                }
                            }
                        });
                    }

                    // Helper function to generate random colors
                    function getRandomColor() {
                        var letters = '0123456789ABCDEF';
                        var color = '#';
                        for (var i = 0; i < 6; i++) {
                            color += letters[Math.floor(Math.random() * 16)];
                        }
                        return color;
                    }

                    // Load all charts
                    loadChart('installation_states', 'installationChart');
                    loadChart('reclamation_monthly', 'reclamationChart');
                    loadChart('intervention_states', 'interventionChart');
                    loadChart('alarms_by_type', 'alarmChart');
                });
            </script>
        </t>
    </template>
</odoo>